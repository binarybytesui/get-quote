<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>Quotation with PDF Actions</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <!--<link rel="stylesheet" href="/public/user/assets/css/style.css">-->
    <!--UPDATE LATER WHEN INLINE MOVED TO /public/user/assets/css/style.css -->
    <style>
        /* Custom styles for the invoice, combining and prioritizing ztemplate.html's look */
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }

        /* The main content area to be converted to PDF */
        .invoice-document {
            max-width: 1000px;
            /* Layout width from ztemplate.html */
            margin: 2rem auto;
            padding: 40px;
            background-color: white;
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }

        .company-logo {
            width: 50px;
            height: 50px;
        }

        /* Using text-purple from ztemplate.html for consistency */
        .text-purple {
            color: #883cab;
        }

        .invoice-table thead th {
            background-color: #883cab;
            color: white;
            font-weight: bold;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #883cab;
            font-size: 14px;
        }

        .invoice-table tbody td,
        .invoice-table tfoot td {
            /* Added tfoot td from quote.html for consistent styling */
            padding: 8px;
            border: 1px solid #dee2e6;
            font-size: 13px;
            vertical-align: middle;
            min-height: 30px;
            /* Adjust this value as needed for your desired row height */
            height: 30px;
            /* Set a fixed height */
            /* The 'height' property might be ignored by tables if content forces it wider.
               'min-height' is often more effective for ensuring a minimum,
               while 'height' tries to enforce an exact height.
               For consistency, applying both can help. */
            overflow: hidden;
            /* Hide content if it exceeds the fixed height */
        }

        /* Notes section style from quote.html */
        .notes-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Floating Action Buttons Container (from ztemplate.html) */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            /* Aligns buttons vertically */
            gap: 15px;
            /* Adds space between buttons */
        }

        /* This CSS creates a floating action button styled for a back or navigation icon.
 * It uses a neutral gray color to indicate a non-destructive action.
 */
        .back-fab {
            /* Basic dimensions and shape, based on the user's provided example */
            width: 45px;
            height: 45px;
            border-radius: 50%;

            /* A neutral gray color for the back button */
            background-color: #6c757d;
            color: white;
            /* For the icon or text inside */
            border: none;

            /* Centering the icon or text inside the button */
            display: flex;
            justify-content: center;
            align-items: center;

            /* Font size for the icon or text */
            font-size: 20px;

            /* Adding a shadow for a "floating" effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;

            /* Smooth transitions for hover effects */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Hover and active states for user interaction, adapted from the example */
        .back-fab:hover {
            /* Slightly increase size and shadow on hover */
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .back-fab:active {
            /* Slight press-down effect */
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* This CSS creates a floating action button styled to look like the WhatsApp icon.
        * It is based on the `.fab` example provided, with changes to the color scheme.*/
        .whatsapp-fab {
            /* Basic dimensions and shape */
            width: 45px;
            height: 45px;
            border-radius: 50%;
            /* WhatsApp's official green color */
            background-color: #25D366;
            color: white;
            /* For the icon */
            border: none;
            /* Centering the icon inside */
            display: flex;
            justify-content: center;
            align-items: center;
            /* Using a larger font size for the icon */
            font-size: 20px;
            /* Adding a shadow for a "floating" effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            /* Smooth transitions for hover effects */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Hover and active states for user interaction */
        .whatsapp-fab:hover {
            /* Slightly increase size and shadow on hover */
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .whatsapp-fab:active {
            /* Slight press-down effect */
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* This CSS creates a floating action button styled for a PDF icon.
 * It uses a deep red color commonly associated with PDF files.
 */
        .pdf-fab {
            /* Basic dimensions and shape, based on the user's provided example */
            width: 45px;
            height: 45px;
            border-radius: 50%;

            /* A red color commonly used for PDF icons */
            background-color: #dc2f2e;
            color: white;
            /* For the icon or text inside */
            border: none;

            /* Centering the icon or text inside the button */
            display: flex;
            justify-content: center;
            align-items: center;

            /* Font size for the icon or text */
            font-size: 20px;

            /* Adding a shadow for a "floating" effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;

            /* Smooth transitions for hover effects */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Hover and active states for user interaction, adapted from the example */
        .pdf-fab:hover {
            /* Slightly increase size and shadow on hover */
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .pdf-fab:active {
            /* Slight press-down effect */
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }


        /* Styling for the circular floating action buttons (from ztemplate.html) */
        .fab {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #883cab;
            /* Purple background */
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Hover effect for the buttons */
        .fab:hover {
            transform: scale(1.1);
            /* Zoom effect */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* Removed all @media queries to ensure static layout as requested */

        /* --- START: PDF Specific Print Styles for Tables (from quote.html) --- */
        @media print {
            .invoice-table {
                width: 100% !important;
                border-collapse: collapse;
            }

            .invoice-table thead {
                display: table-header-group;
            }

            .invoice-table tfoot {
                display: table-footer-group;
                page-break-before: avoid;
            }

            .invoice-table tbody tr {
                page-break-inside: avoid;
            }

            .invoice-table td,
            .invoice-table th {
                white-space: normal;
                word-wrap: break-word;
            }

            .html2pdf__page-break {
                height: 0;
                page-break-before: always;
            }
        }

        /* --- END: PDF Specific Print Styles for Tables --- */
    </style>
</head>

<body>
    <div class="invoice-document" id="element-to-print">
        <header class="d-flex justify-content-between align-items-center pb-4 mb-4 border-bottom">
            <div>
                <img src="/get-quote/public/user/assets/img/main.png" alt="Company Logo" class="company-logo rounded-circle">
                <h2 class="d-inline-block align-middle ms-3 mb-0 fw-bold">Quotation</h2>
            </div>
            <div class="text-end">
                <h4 class="fw-bolder text-purple mb-1">InControls Automation Services</h4>
                <!-- <p class="text-muted mb-0">info@incontrolsautomation.com</p> -->
                <a class="link-offset-2 link-underline link-underline-opacity-0"
                    href="mailto:info@incontrolsautomation.com?&subject=Quotation Product Enquiry&body=Please attach the quotation PDF for specific enquiry related to it"
                    target="_top" style="color: inherit" onMouseOver="this.style.color='#883cab'"
                    onMouseOut="this.style.color='inherit'">info@incontrolsautomation.com</a>
            </div>
        </header>

        <div class="row mb-4">
            <div class="col-md-6">
                <h5 class="fw-bold">Quote To:</h5>
                <p class="mb-0 fw-bold">Company Name: <span id="displayCompanyName" class="fw-normal"></span></p>
                <p class="mb-0 fw-bold">Client Name: <span id="displayContactPerson" class="fw-normal"></span></p>
                <p class="mb-0 fw-bold">Email: <span id="displayEmail" class="fw-normal"></span></p>
                <p class="mb-0 fw-bold">Mobile: <span id="displayMobileNumber" class="fw-normal"></span></p>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <p class="mb-1 fw-bold">Quote #: <span id="invoiceNumber" class="fw-normal"></span></p>
                <p class=" mb-0 fw-bold"><span id="currentDate" class="fw-normal"></span></p>
            </div>
        </div>

        <div id="quotationDetails">
            <div class="table-responsive">
                <table class="table table-bordered invoice-table">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 10%;">Sr. No.</th>
                            <th class="text-start" style="width: 55%;">Product Name</th>
                            <th class="text-center" style="width: 20%;">Part No.</th>
                            <th class="text-center" style="width: 15%;">Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="quotationTableBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end fw-bold">Total Quantity:</td>
                            <td class="text-center fw-bold" id="totalquantity"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end fw-bold">Grand Total:</td>
                            <td class="text-center fw-bold" id="grandTotal"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="emptyQuotationMessage" class="alert alert-info" style="display: none;">
            <p class="mb-0 text-center">No products selected for quotation. Please go back to the <a href="index.html"
                    class="alert-link">Product Selection Page</a> to select products.</p>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="notes-section">
                    <p class="mb-2"><strong>Note:</strong> ALL MATERIAL IS CONSIDERED AS PER PRELIMINARY INSPECTION AND
                        INPUTS, INCASE OF ANY CHANGES IN DESIGN WILL BE DONE AFTER APPROVAL AND REVISED COST
                        IMPLICATIONS IF ANY.</p>
                </div>
            </div>
        </div>
        <footer class="mt-5 text-center text-muted">
            <p>Thank you for your business!</p>
            <p class="small">D203, Yashosthan Society Kondhwa Budruk | Pune, MH | 411048 | <a
                    class="link-offset-2 link-underline link-underline-opacity-0"
                    href="mailto:info@incontrolsautomation.com?&subject=Quotation Product Enquiry&body=Please attach the quotation PDF for specific enquiry related to it..."
                    target="_top" style="color: inherit" onMouseOver="this.style.color='#883cab'"
                    onMouseOut="this.style.color='inherit'">info@incontrolsautomation.com</a>
            </p>
        </footer>
    </div>

    <div class="fab-container" id="fab-container">
        <button class="back-fab" onclick="goBack()" title="Go Back"><i class="bi bi-arrow-left"></i></button>
        <button class="whatsapp-fab" onclick="sharePdf()" title="Share as PDF"><i class="bi bi-whatsapp"></i></button>
        <button class="pdf-fab" onclick="downloadPdf()" title="Download as PDF"><i class="bi bi-file-pdf"></i></button>
    </div>

    <script>
        /**
         * Core logic to load data from sessionStorage and populate the page (from quote.html).
         */
        document.addEventListener('DOMContentLoaded', function () {
            const selectedProductsJSON = sessionStorage.getItem('selectedProducts');
            const contactInfoJSON = sessionStorage.getItem('contactInfo');

            const quotationTableBody = document.getElementById('quotationTableBody');
            const totalQuantityDisplay = document.getElementById('totalquantity');
            const grandTotalDisplay = document.getElementById('grandTotal');
            const quotationDetails = document.getElementById('quotationDetails');
            const emptyQuotationMessage = document.getElementById('emptyQuotationMessage');

            const displayCompanyName = document.getElementById('displayCompanyName');
            const displayContactPerson = document.getElementById('displayContactPerson');
            const displayEmail = document.getElementById('displayEmail');
            const displayMobileNumber = document.getElementById('displayMobileNumber');

            // Set current date
            const dateElement = document.getElementById('currentDate');
            const today = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            dateElement.innerHTML = `<b>Date:</b> ${today.getDate()} ${monthNames[today.getMonth()]}, ${today.getFullYear()}`;

            // Generate and display invoice number
            const invoiceNumberElement = document.getElementById('invoiceNumber');
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yy = String(now.getFullYear()).slice(-2);
            invoiceNumberElement.textContent = `INC_${dd}${mm}${yy}${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;

            // Display contact information
            if (contactInfoJSON) {
                const contactInfo = JSON.parse(contactInfoJSON);
                displayCompanyName.textContent = contactInfo.companyName || 'N/A';
                displayContactPerson.textContent = contactInfo.contactPerson || 'N/A';
                displayEmail.textContent = contactInfo.email || 'N/A';
                displayMobileNumber.textContent = contactInfo.mobileNumber || 'N/A';
            } else {
                console.warn('Contact information not found in sessionStorage.');
            }

            // Define the number of default rows
            const NUM_DEFAULT_ROWS = 20;

            // Populate products table
            if (selectedProductsJSON) {
                const selectedProducts = JSON.parse(selectedProductsJSON);

                // If no products are selected, show the empty message and return
                if (selectedProducts.length === 0) {
                    quotationDetails.style.display = 'none';
                    emptyQuotationMessage.style.display = 'block';

                    // Still create default empty rows if no products are selected
                    for (let i = 0; i < NUM_DEFAULT_ROWS; i++) {
                        const row = quotationTableBody.insertRow();
                        row.innerHTML = `
                            <td class="text-center"></td> <td></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                        `;
                    }
                    return; // Exit here as no products to populate
                }

                let totalQuantity = 0;
                let grandTotal = 0;
                let srNoCounter = 0; // Initialize a counter for Sr. No.

                // Determine the number of rows to iterate over (at least NUM_DEFAULT_ROWS or more if products exceed it)
                const rowsToGenerate = Math.max(selectedProducts.length, NUM_DEFAULT_ROWS);

                for (let i = 0; i < rowsToGenerate; i++) {
                    const row = quotationTableBody.insertRow();
                    const item = selectedProducts[i]; // Get item at current index

                    if (item && item.name && Number(item.quantity) > 0) { // Check if product name and quantity are available
                        srNoCounter++; // Increment Sr. No. only if product data is valid
                        const itemQuantity = Number(item.quantity);
                        const itemPrice = Number(item.price) || 0; // Note: price is not displayed in this layout, but kept for total calculation consistency
                        const subtotal = itemQuantity * itemPrice;

                        row.innerHTML = `
                            <td class="text-center">${srNoCounter}.</td>
                            <td>${item.name}</td>
                            <td class="text-center">${item.partNo}</td>
                            <td class="text-center">${itemQuantity}</td>
                        `;
                        totalQuantity += itemQuantity;
                        grandTotal += subtotal;
                    } else {
                        // If item does not exist or product name/quantity are missing, create an empty row
                        row.innerHTML = `
                            <td class="text-center"></td>
                            <td></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                        `;
                    }
                }

                totalQuantityDisplay.textContent = totalQuantity;
                // Grand Total calculation is based on quantity * price, but the layout doesn't show individual prices.
                // Keeping the grandTotal calculation for consistency, but it will always be 0 if prices are not stored/retrieved.
                // If prices are needed, they would need to be passed via sessionStorage or fetched.
                grandTotalDisplay.textContent = `â‚¹${grandTotal.toFixed(2)}`;
                quotationDetails.style.display = 'block';
                emptyQuotationMessage.style.display = 'none';

            } else {
                // If no selectedProductsJSON, display empty message and create default empty rows
                quotationDetails.style.display = 'none';
                emptyQuotationMessage.style.display = 'block';

                for (let i = 0; i < NUM_DEFAULT_ROWS; i++) {
                    const row = quotationTableBody.insertRow();
                    row.innerHTML = `
                        <td class="text-center"></td>
                        <td></td>
                        <td class="text-center"></td>
                        <td class="text-center"></td>
                    `;
                }
            }
        });

        /**
         * Navigates back to the index.html page.
         */
        function goBack() {
            window.location.href = 'index.html';
        }

        /**
         * Generates a timestamped filename for the PDF.
         * Format: Incontrols_DDMMYYYY_HHMMSS.pdf
         * @returns {string} The formatted filename.
         */
        function generateFilename() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `Incontrols_${day}${month}${year}_${hours}${minutes}${seconds}.pdf`;
        }

        /**
         * Handles the PDF download process using html2canvas and jsPDF (from quote.html).
         */
        async function downloadPdf() {
            const fabContainer = document.getElementById('fab-container');
            const elementToPrint = document.getElementById('element-to-print');
            const filename = generateFilename();

            fabContainer.style.display = 'none'; // Hide buttons during PDF generation
            try {
                const canvas = await html2canvas(elementToPrint, {
                    scale: 2, // Higher scale for better resolution
                    useCORS: true, // Use CORS if images are from different origins
                    letterRendering: true // Attempts to improve text rendering
                });

                const imgData = canvas.toDataURL('image/jpeg');
                const { jsPDF } = window.jspdf; // Access jsPDF constructor
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height] // Set PDF format to canvas dimensions
                });

                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height); // Add image to PDF
                pdf.save(filename); // Save the PDF
            } catch (error) {
                console.error("PDF download failed:", error);
                // In a real application, you'd show a custom alert/modal here instead of the native alert()
                console.warn("Could not generate PDF. Please try again.");
            } finally {
                fabContainer.style.display = 'flex'; // Show buttons again
            }
        }

        /**
         * Handles sharing the PDF using the Web Share API with a download fallback (from quote.html).
         */
        async function sharePdf() {
            const fabContainer = document.getElementById('fab-container');
            const elementToPrint = document.getElementById('element-to-print');
            const filename = generateFilename();

            fabContainer.style.display = 'none'; // Hide buttons during PDF generation
            try {
                const canvas = await html2canvas(elementToPrint, {
                    scale: 2,
                    useCORS: false, // Set to false as per quote.html, adjust if external images are used
                    letterRendering: true
                });

                const imgData = canvas.toDataURL('image/jpeg');
                const { jsPDF } = window.jspdf; // Access jsPDF constructor
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });

                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);

                const blob = pdf.output('blob'); // Get PDF as a Blob
                const file = new File([blob], filename, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Quotation PDF',
                        text: `Here is the quotation: ${filename}`,
                    });
                } else {
                    // Fallback to download if sharing is not supported
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error("PDF sharing failed:", error);
                // In a real application, you'd show a custom alert/modal here instead of the native alert()
                console.warn("Sharing failed. Please try downloading instead.");
            } finally {
                fabContainer.style.display = 'flex'; // Show buttons again
            }
        }
    </script>
</body>

</html>